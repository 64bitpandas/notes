<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="Query Optimization"><meta property="og:description" content="Introduction #  Query optimization is the bridge between a declarative language (like SQL, where you describe “what” you want) and an imperative language (like Java, which describes how the answer is actually computed). Here, we built the translator that converts SQL into logic that a computer can understand.
If you think about it, this can be really complicated- there&rsquo;s lots of ways to execute a query (i.e. many equivalent relational algebra statements), and we have to somehow figure out which one is the best without executing any of them!"><meta property="og:type" content="article"><meta property="og:url" content="https://notes.bencuan.me/cs186/07-Query-Optimization/"><meta property="article:section" content="cs186"><meta property="article:modified_time" content="2023-01-10T23:44:26+00:00"><meta property="og:site_name" content="🗒️ Ben's Notes"><title>Query Optimization | 🗒️ Ben's Notes</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.9571c7adb6029c898bf9b839bbb08bbb02cf98ea0b2512213e6dad0a0b116159.css integrity="sha256-lXHHrbYCnImL+bg5u7CLuwLPmOoLJRIhPm2tCgsRYVk=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="Introduction #  Query optimization is the bridge between a declarative language (like SQL, where you describe “what” you want) and an imperative language (like Java, which describes how the answer is actually computed). Here, we built the translator that converts SQL into logic that a computer can understand.
If you think about it, this can be really complicated- there&rsquo;s lots of ways to execute a query (i.e. many equivalent relational algebra statements), and we have to somehow figure out which one is the best without executing any of them!"><title>Query Optimization</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://notes.bencuan.me//favicon.png><link href=https://notes.bencuan.me/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://notes.bencuan.me/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://notes.bencuan.me/quartz/js/darkmode.9d3e1c1ebec61822893ee54cff5423d0.min.js></script>
<script src=https://notes.bencuan.me/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://notes.bencuan.me/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://notes.bencuan.me/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://notes.bencuan.me/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://notes.bencuan.me/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://notes.bencuan.me/",fetchData=Promise.all([fetch("https://notes.bencuan.me/indices/linkIndex.68587926b15a523610470d276acdfef2.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://notes.bencuan.me/indices/contentIndex.dfd7854505f6353a83875393f9d06bac.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,i=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://notes.bencuan.me",!0);const s=document.getElementById("footer");if(s){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=!0;drawGraph("https://notes.bencuan.me",t,[{"/cs61b":"#4388cc"},{"/data102":"#ba0af0"},{"/cs70":"#70fa70"},{"/cs61a":"#fbff22"},{"/cs186":"#ffaf1c"},{"/cs168":"#ff86a1"},{"/cs162":"#ffdfdd"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var o=document.getElementsByClassName("mermaid");o.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://notes.bencuan.me/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://notes.bencuan.me/>🗒️ Ben's Notes</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><input type=checkbox id=section-da99de074169576d9f77860d41691a68 class=toggle>
<label for=section-da99de074169576d9f77860d41691a68 class="flex justify-between"><a href=/cs61b/ class=book-collapse-toggle>CS 61B: Data Structures</a></label><ul><li><span class=book-menu-title>Object Oriented Programming</span><ul><li><a href=/cs61b/oop/inheritance/>Inheritance</a></li><li><a href=/cs61b/oop/access-control/>Access Control</a></li><li><a href=/cs61b/oop/dynamic-method-selection/>Dynamic Method Selection</a></li><li><a href=/cs61b/oop/objects/>Java Objects</a></li><li><a href=/cs61b/oop/generics/>Generic Types</a></li></ul></li><li><span class=book-menu-title>Asymptotics</span><ul><li><a href=/cs61b/asymptotics/asymptotics/>Asymptotic Analysis Basics</a></li><li><a href=/cs61b/asymptotics/amortization/>Amortization</a></li><li><a href=/cs61b/asymptotics/asymptotics-practice/>Asymptotics Practice</a></li></ul></li><li><span class=book-menu-title>Abstract Data Types</span><ul><li><input type=checkbox id=section-70dba6a254ce0b2bcdb77dd58dbf6cdc class=toggle>
<label for=section-70dba6a254ce0b2bcdb77dd58dbf6cdc class="flex justify-between"><a href=/cs61b/abstract-data-types/collections/ class=book-collapse-toggle>Collections</a></label><ul><li><a href=/cs61b/abstract-data-types/collections/arrays/>Arrays</a></li><li><a href=/cs61b/abstract-data-types/collections/linked-lists/>Linked Lists</a></li><li><a href=/cs61b/abstract-data-types/collections/sets/>Sets</a></li><li><a href=/cs61b/abstract-data-types/collections/stacks-and-queues/>Stacks and Queues</a></li></ul></li><li><input type=checkbox id=section-5eb2d5b415a82a45c7861774887e844b class=toggle>
<label for=section-5eb2d5b415a82a45c7861774887e844b class="flex justify-between"><a href=/cs61b/abstract-data-types/binary-trees/ class=book-collapse-toggle>Binary Trees</a></label><ul><li><a href=/cs61b/abstract-data-types/binary-trees/balanced-search-structures/>Balanced Search Structures</a></li><li><a href=/cs61b/abstract-data-types/binary-trees/heaps/>Heaps</a></li><li><a href=/cs61b/abstract-data-types/binary-trees/tries/>Tries</a></li></ul></li><li><a href=/cs61b/abstract-data-types/graphs/>Graphs</a></li><li><a href=/cs61b/abstract-data-types/hashing/>Hashing and Hash Tables</a></li><li><a href=/cs61b/abstract-data-types/union-find-disjoint-sets/>Union Find (Disjoint Sets)</a></li><li><a href=/cs61b/abstract-data-types/comparables-and-comparators/>Comparables and Comparators</a></li></ul></li><li><span class=book-menu-title>Algorithms</span><ul><li><input type=checkbox id=section-26838f44377a3dfc0925929b8b82de69 class=toggle>
<label for=section-26838f44377a3dfc0925929b8b82de69 class="flex justify-between"><a href=/cs61b/algorithms/searching/ class=book-collapse-toggle>Searching</a></label><ul><li><a href=/cs61b/algorithms/searching/binary-search/>Binary Search</a></li><li><a href=/cs61b/algorithms/searching/breadth-first-search-bfs/>Breadth First Search (DFS)</a></li><li><a href=/cs61b/algorithms/searching/depth-first-search-dfs/>Depth First Search (DFS)</a></li></ul></li><li><input type=checkbox id=section-fd5238a874e42ff4e1ab0e65c20a9824 class=toggle>
<label for=section-fd5238a874e42ff4e1ab0e65c20a9824 class="flex justify-between"><a href=/cs61b/algorithms/shortest-paths/ class=book-collapse-toggle>Shortest Paths</a></label><ul><li><a href=/cs61b/algorithms/shortest-paths/dijkstras-algorithm/>Dijkstra's Algorithm</a></li><li><a href=/cs61b/algorithms/shortest-paths/a-search/>A* Search</a></li></ul></li><li><input type=checkbox id=section-434cf8cf80558e0886666bff24d740d1 class=toggle>
<label for=section-434cf8cf80558e0886666bff24d740d1 class="flex justify-between"><a href=/cs61b/algorithms/minimum-spanning-trees/ class=book-collapse-toggle>Minimum Spanning Trees</a></label><ul><li><a href=/cs61b/algorithms/minimum-spanning-trees/kruskals-algorithm/>Kruskal's Algorithm</a></li><li><a href=/cs61b/algorithms/minimum-spanning-trees/prims-algorithm/>Prim's Algorithm</a></li></ul></li><li><a href=/cs61b/algorithms/sorting/>Sorting</a></li><li><a href=/cs61b/algorithms/minimax/>Minimax Algorithm</a></li></ul></li><li><span class=book-menu-title>Misc. Topics</span><ul><li><a href=/cs61b/misc-topics/exceptions/>Exceptions</a></li><li><a href=/cs61b/misc-topics/modular-arithmetic/>Modular Arithmetic</a></li><li><a href=/cs61b/misc-topics/more-resources/>More Resources</a></li></ul></li></ul></li><li><input type=checkbox id=section-ee67b82ee54e976a9f81e3e41661ae13 class=toggle>
<label for=section-ee67b82ee54e976a9f81e3e41661ae13 class="flex justify-between"><a href=/cs70/ class=book-collapse-toggle>CS 70: Discrete Math</a></label><ul><li><a href=/cs70/latex-reference/>LaTeX Reference</a></li><li><span class=book-menu-title>Discrete Math</span><ul><li><a href=/cs70/discrete-math/overview/>Discrete Math Overview</a></li><li><a href=/cs70/discrete-math/propositional-logic/>Propositional Logic</a></li><li><a href=/cs70/discrete-math/proofs/>Proofs</a></li><li><a href=/cs70/discrete-math/stable-matching/>Stable Matching</a></li><li><a href=/cs70/discrete-math/graphs/>Graphs</a></li><li><a href=/cs70/discrete-math/modular-arithmetic/>Modular Arithmetic</a></li><li><a href=/cs70/discrete-math/rsa-cryptography/>RSA Cryptography</a></li><li><a href=/cs70/discrete-math/polynomials/>Polynomials</a></li><li><a href=/cs70/discrete-math/countability/>Countability</a></li><li><a href=/cs70/discrete-math/computability/>Computability</a></li></ul></li><li><span class=book-menu-title>Probability</span><ul><li><a href=/cs70/probability/probability-overview/>Probability Overview</a></li><li><a href=/cs70/probability/counting/>Counting</a></li><li><a href=/cs70/probability/discrete-probability/>Discrete Probability</a></li><li><a href=/cs70/probability/hashing-and-the-union-bound/>Hashing and the Union Bound</a></li><li><a href=/cs70/probability/expectation-and-variance/>Expectation and Variance</a></li><li><a href=/cs70/probability/concentration-inequalities/>Concentration Inequalities</a></li><li><a href=/cs70/probability/continuous-probability/>Continuous Probability</a></li><li><a href=/cs70/probability/markov-chains/>Markov Chains</a></li><li><a href=/cs70/probability/the-beta-family/>The Beta Family</a></li><li><a href=/cs70/probability/conditional-expectation-and-variance/>Conditional Expectation and Variance</a></li></ul></li></ul></li><li><input type=checkbox id=section-6d80b867b0e7b10bf4afdb6cb30147b7 class=toggle checked>
<label for=section-6d80b867b0e7b10bf4afdb6cb30147b7 class="flex justify-between"><a href=/cs186/ class=book-collapse-toggle>CS 186: Databases</a></label><ul><li><a href=/cs186/io/>What is an I/O and why should I care?</a></li><li><a href=/cs186/00-SQL-Basics/>SQL Basics</a></li><li><a href=/cs186/01-Disks-Buffers-Files/>Disks, Buffers, and Files</a></li><li><a href=/cs186/02-B+-Trees/>B+ Trees</a></li><li><a href=/cs186/03-Buffer-Management/>Buffer Management</a></li><li><a href=/cs186/04-Sorting-and-Hashing/>Sorting and Hashing</a></li><li><a href=/cs186/05-Iterators-and-Joins/>Iterators and Joins</a></li><li><a href=/cs186/06-Relational-Algebra/>Relational Algebra</a></li><li><a href=/cs186/07-Query-Optimization/ class=active>Query Optimization</a></li><li><a href=/cs186/08-Transactions/>Transactions and ACID</a></li><li><a href=/cs186/09-Parallel-Query-Processing/>Parallel Query Processing</a></li><li><a href=/cs186/10-Recovery/>Recovery</a></li><li><a href=/cs186/11-Distributed-Transactions/>Distributed Transactions</a></li><li><a href=/cs186/12-ER-Diagrams/>E-R Diagrams</a></li></ul></li><li><input type=checkbox id=section-a5f138e4453c6deda66a767c13d8a673 class=toggle>
<label for=section-a5f138e4453c6deda66a767c13d8a673 class="flex justify-between"><a href=/cs162/ class=book-collapse-toggle>CS 162: Operating Systems</a></label><ul><li><a href=/cs162/Chapter-1-OS-Basics/>Chapter 1: OS Basics</a></li><li><a href=/cs162/Chapter-2-Processes/>Chapter 2: Processes</a></li><li><a href=/cs162/Chapter-3-Threads/>Chapter 3: Threads</a></li><li><a href=/cs162/Chapter-4-I-O/>Chapter 4: I/O</a></li><li><a href=/cs162/Chapter-5-Synchronization/>Chapter 5: Synchronization</a></li><li><a href=/cs162/Chapter-6-Scheduling/>Chapter 6: S cheduling</a></li><li><a href=/cs162/Chapter-7-Address-Translation/>Chapter 7: Address Translation</a></li><li><a href=/cs162/Chapter-8-Caching/>Chapter 8: Caching</a></li><li><a href=/cs162/Chapter-9-File-Systems/>Chapter 9: File Systems</a></li><li><a href=/cs162/Appendix-A-GDB-foobars/>GDB Reference</a></li></ul></li><li><input type=checkbox id=section-d6662b440d117f766a2c3bdd162dce8f class=toggle>
<label for=section-d6662b440d117f766a2c3bdd162dce8f class="flex justify-between"><a href=/cs168/ class=book-collapse-toggle>CS 168: The Internet</a></label><ul><li><a href=/cs168/intro-to-the-internet/>Intro to the Internet</a></li><li><a href=/cs168/cli/>CLI Tools</a></li><li><a href=/cs168/intradomain-routing/>Introduction to Routing</a></li><li><a href=/cs168/measuring-link-performance/>Measuring Link Performance</a></li><li><a href=/cs168/resource-sharing-packet-and-circuit-switching/>Resource Sharing</a></li><li><a href=/cs168/internet-organization-and-layers/>Internet Organization</a></li><li><a href=/cs168/sockets-and-ports/>Sockets and Ports</a></li><li><a href=/cs168/addressing-ip/>Addressing</a></li><li><a href=/cs168/interdomain-routing-bgp/>Interdomain Routing (BGP)</a></li><li><a href=/cs168/TCP/>TCP</a></li><li><a href=/cs168/reliability/>Reliability</a></li><li><a href=/cs168/congestion-control/>Congestion Control</a></li><li><a href=/cs168/dns/>DNS</a></li><li><a href=/cs168/web/>Web</a></li><li><a href=/cs168/ethernet/>Ethernet</a></li><li><a href=/cs168/end-to-end-operation/>End to End Operation</a></li><li><a href=/cs168/final-review/>Final Review</a></li></ul></li><li><input type=checkbox id=section-0ab56f4e325729fc5ee23c1204712a3e class=toggle>
<label for=section-0ab56f4e325729fc5ee23c1204712a3e class="flex justify-between"><a href=/cs61a/ class=book-collapse-toggle>CS 61A: Computer Programs</a></label><ul><li><a href=/cs61a/resources/>Resources</a></li><li><a href=/cs61a/midterm-tips/>Midterm Tips</a></li></ul></li><li><input type=checkbox id=section-7a47eedeadc37bd22193fe5cd002031e class=toggle>
<label for=section-7a47eedeadc37bd22193fe5cd002031e class="flex justify-between"><a href=/data102/ class=book-collapse-toggle>Data 102: Inference</a></label><ul><li><a href=/data102/binary-decision-making/>Binary Decision Making</a></li><li><a href=/data102/hypothesis-testing/>Hypothesis Testing</a></li><li><a href=/data102/decision-theory/>Decision Theory</a></li><li><a href=/data102/parameter-estimation/>Parameter Estimation</a></li><li><a href=/data102/sampling/>Sampling</a></li><li><a href=/data102/regression-and-glms/>Regression and GLMs</a></li><li><a href=/data102/nonparametric-methods/>Nonparametric Methods</a></li><li><a href=/data102/interpretability/>Interpretability</a></li><li><a href=/data102/causality/>Causality</a></li><li><a href=/data102/concentration-inequalities/>Concentration Inequalities</a></li><li><a href=/data102/bandits/>Bandits</a></li><li><a href=/data102/Markov-Decision-Processes/>Markov Decision Processes</a></li><li><a href=/data102/Reinforcement-Learning/>Reinforcement Learning</a></li></ul></li></ul><ul><li><a href=/contributing target=_blank rel=noopener>Contribute</a></li><li><a href=https://github.com/64bitpandas/notes/issues target=_blank rel=noopener>Feedback</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>Query Optimization</h1><h2 id=introduction>Introduction
<a class=anchor href=#introduction>#</a></h2><p><strong>Query optimization</strong> is the bridge between a declarative language (like SQL, where you describe “what” you want) and an imperative language (like Java, which describes how the answer is actually computed). Here, we built the translator that converts SQL into logic that a computer can understand.</p><p>If you think about it, this can be really complicated- there&rsquo;s lots of ways to execute a query (i.e. many equivalent relational algebra statements), and we have to somehow figure out which one is the best <em>without</em> executing any of them!</p><h2 id=relevant-materials>Relevant Materials
<a class=anchor href=#relevant-materials>#</a></h2><ul><li><a href=https://notes.bencuan.me/cs186/coursenotes/n10-QueryOpt.pdf rel=noopener>Note 10</a></li><li><a href=https://docs.google.com/presentation/d/1rvAz_Ms1uxLiyQqGmv-R_xU9NqOjNVzYEWekrtHNuDc/edit rel=noopener>Discussion 7</a></li></ul><h2 id=system-r-optimizers>System R Optimizers
<a class=anchor href=#system-r-optimizers>#</a></h2><p>The System R query optimizer framework was conceptualized in the 1970s, and lays the framework for most modern query optimizers today. This is what we will be studying in this class.</p><p><img src=https://notes.bencuan.me/cs186/Query%20Optimization/Untitled.png width=auto alt=Untitled></p><p>In System R, the query parser first checks for correctness and authorization (user permissions to access the table). It then generates a parse tree out of the query. This step is usually fairly straightforward, since it&rsquo;s just breaking up the query into chunks that our programming language can understand, without having to make any decisions.</p><p>Next, the query rewriter converts queries into even smaller query blocks (like a single WHERE clause), and flattens the views.</p><p>Once the query is rewritten, it gets passed into the query optimizer. The primary goal of a query optimizer is to translate a simple query plan into a better query plan. A cost-based query optimizer processes one query block at a time (e.g. select, project, join, group by, order by).</p><ul><li><p>For each block, consider:</p><ul><li>all relevant access methods</li><li>All left-deep join trees: right branches are always simple FROM clauses. Observe the illustration below for examples of left-deep and not-left-deep trees:</li></ul><p><img src=https://notes.bencuan.me/cs186/Query%20Optimization/Untitled%201.png width=auto alt=Untitled></p></li></ul><p>Typically, we don’t care about exact performance; the main purpose of query optimization is to prune out extremely inefficient options. As long as the final result is good enough, we&rsquo;re happy!</p><h2 id=the-components-of-a-query-optimizer>The Components of a Query Optimizer
<a class=anchor href=#the-components-of-a-query-optimizer>#</a></h2><p>There are three main problems:</p><ol><li><strong>Plan space:</strong> for a given query, what plans are considered?<ol><li>Two query plans are <strong>physically equivalent</strong> if they result in the same content and the same physical properties (primarily sort order and hash grouping).</li></ol></li><li><strong>Cost estimation:</strong> how do we estimate how much a plan will cost?<ol><li>In System R, cost is represented as a single number: <code>I/Os + CPU-factor*#tuples</code> (where CPU factor is the proportion of time the system spends actually computing the query). For the purposes of this class, we&rsquo;ll only focus on the I/O cost.</li><li>For each term, determine its <strong>selectivity</strong> $S$ (size of output / size of input). Lower selectivity value is better (filters more items).<ol><li>Result cardinality is equal to the max number of tuples multiplied by the product of all selectivities.</li><li>If searching for <code>col = value</code>, $S = 1/N(l)$ where $N(l)$ is the number of unique values in the table.</li><li>If searching for <code>col1 = col2</code>, then $S = 1/max(N(l_1), N(l_2))$.</li><li>If searching for <code>col > value</code>, then $S = (max(l) - value) / max(l) - min(l) + 1).$</li><li>If we are missing the needed stats to compute any of the above, assume that $S = 1/10$.</li><li>If searching for a disjunction (or) $Q_1 \lor Q_2$, $S = S_1 + S_2 - (S_1 \times S_2)$.</li><li>If searching for a conjunction (and) $Q_1 \land Q2$, $S = S_1 \times S_2$.</li><li>If searching for a negation (not), $\lnot Q_1$, $S = 1 - S_1$.</li><li>For joins, simply apply the selectivity query to the cross product of the two tables that are being joined.</li></ol></li><li>For clustered indexes, the approximate number of IOs is $(P(L) + P(R)) \times S$ where $P$ is the number of pages and $S$ is selectivity.</li><li>For unclustered indexes, the approximate cost is $(P(L) + T(R))\times S$ where $T$ is the number of tuples.</li><li>A sequential scan of a file takes $N(R)$ cost.</li></ol></li><li><strong>Search strategy:</strong> how do we search the plan space?</li></ol><h2 id=selectivity-estimation>Selectivity Estimation
<a class=anchor href=#selectivity-estimation>#</a></h2><p>Since the number of rows in our output depends heavily on the data and what selections we make out of it, we need a way to estimate the size of outputs after each operation. This is known as <strong>selectivity estimation.</strong></p><p>Like evaluating query cost, selectivity estimation is very rough and generally prioritizes speed over accuracy- so much so that <strong>if we don&rsquo;t have enough information, we just assign an operation the arbitrary selectivity value of</strong> $1/10$ (meaning that the the output has 1/10 of the number of rows as the input).</p><p>Below are some charts from discussion of some common cases you might run into, and how to calculate their selectivity. Assume the following:</p><ul><li><code>|c|</code> corresponds to the number of <em>distinct values</em> in column c.</li><li>If we have an index on the column, we should also know <code>|c|</code>, and the max/min values.</li></ul><p><img src=https://notes.bencuan.me/cs186/Sorting%20and%20Hashing/Pasted%20image%2020230109180143.png width=auto alt=se1>
<img src=https://notes.bencuan.me/cs186/Sorting%20and%20Hashing/Pasted%20image%2020230109180153.png width=auto alt=se2>
<img src=https://notes.bencuan.me/cs186/Sorting%20and%20Hashing/Pasted%20image%2020230109180200.png width=auto alt=se3>
<img src=https://notes.bencuan.me/cs186/Sorting%20and%20Hashing/Pasted%20image%2020230109180209.png width=auto alt=se4></p><p>To get the number of records in the output, we take the <strong>floor</strong> of the result of multiplying the selectivity estimate with the number of records in the input.</p><h3 id=selectivity-estimation-practice>Selectivity Estimation Practice
<a class=anchor href=#selectivity-estimation-practice>#</a></h3><p>Suppose $R(a,b,c)$ has 1000 tuples and $S(a)$ has 500 tuples. We have the following indexes:</p><ul><li>R.a: 50 unique integers uniformly distributed in $[1, 50]$</li><li>R.b: 100 unique float values uniformly distributed in $[1, 100]$</li><li>S.a: 25 unique integers uniformly distributed in $[1, 25]$</li></ul><p>What is the estimated number of tuples in the output after running the following queries?</p><div class=book-tabs><input type=radio class=toggle name=tabs-q1 id=tabs-q1-0 checked>
<label for=tabs-q1-0>Q1</label><div class="book-tabs-content markdown-inner"><code>SELECT * FROM R;</code></div><input type=radio class=toggle name=tabs-q1 id=tabs-q1-1>
<label for=tabs-q1-1>Q1 Answer</label><div class="book-tabs-content markdown-inner">Full scan requires iterating through every tuple in $R$, so 1000 tuples are outputted.</div></div><div class=book-tabs><input type=radio class=toggle name=tabs-q2 id=tabs-q2-0 checked>
<label for=tabs-q2-0>Q2</label><div class="book-tabs-content markdown-inner"><code>SELECT * FROM R WHERE a = 42;</code></div><input type=radio class=toggle name=tabs-q2 id=tabs-q2-1>
<label for=tabs-q2-1>Q2 Answer</label><div class="book-tabs-content markdown-inner">The selectivity is $1/50$ since there are 50 unique values in $a$ and exactly one of them is desired.
This results in $1000 \times 1/50 = 20$ tuples.</div></div><div class=book-tabs><input type=radio class=toggle name=tabs-q3 id=tabs-q3-0 checked>
<label for=tabs-q3-0>Q3</label><div class="book-tabs-content markdown-inner"><code>SELECT * FROM R WHERE c = 42;</code></div><input type=radio class=toggle name=tabs-q3 id=tabs-q3-1>
<label for=tabs-q3-1>Q3 Answer</label><div class="book-tabs-content markdown-inner">We have no information, so by default $S=1/10.$ $1000 \times 1/10 = 100$ tuples.</div></div><div class=book-tabs><input type=radio class=toggle name=tabs-q4 id=tabs-q4-0 checked>
<label for=tabs-q4-0>Q4</label><div class="book-tabs-content markdown-inner"><code>SELECT * FROM R WHERE a &lt;= 25;</code></div><input type=radio class=toggle name=tabs-q4 id=tabs-q4-1>
<label for=tabs-q4-1>Q4 Answer</label><div class="book-tabs-content markdown-inner">Exactly 1/2 of all possible values of <code>a</code> are less than 25 (exact formula listed above). So $1000 \times 1/2 = 500$ tuples.</div></div><div class=book-tabs><input type=radio class=toggle name=tabs-q5 id=tabs-q5-0 checked>
<label for=tabs-q5-0>Q5</label><div class="book-tabs-content markdown-inner"><code>SELECT * FROM R WHERE b &lt;= 25;</code></div><input type=radio class=toggle name=tabs-q5 id=tabs-q5-1>
<label for=tabs-q5-1>Q5 Answer</label><div class="book-tabs-content markdown-inner">Using the equation for selectivity of inequalities, (value - low) / (high - low) = (25-1)/(100-1) = 24/99. $\lfloor 1000 \times 24/99 \rfloor = 242$ tuples.</div></div><h2 id=common-heuristics>Common Heuristics
<a class=anchor href=#common-heuristics>#</a></h2><p><strong>Selection and projection cascade and pushdown:</strong> apply selections ($\sigma$) and projections ($\pi$) as soon as you have the relevant tables. i.e. push them as far to the right as possible</p><p><strong>Avoid Cartesian products:</strong> given a choice, do theta-joins rather than cross products.</p><p><strong>Put the more effective selection onto the outer loop before a join:</strong> reorder joins such that we are joining a smaller table in the outer loop with a larger table in the inner loop, especially if this allows us to filter out more rows in the outer loop</p><p><strong>Materialize inner tables before joins:</strong> rather than calculating selections on the fly, create a temporary filtered table before passing it into a join</p><ul><li>Not effective 100% of the time since it costs IO’s to write and re-read the table</li></ul><p><strong>Use left-deep trees only</strong> (explained in an earlier section).</p><h2 id=selinger-query-optimization>Selinger Query Optimization
<a class=anchor href=#selinger-query-optimization>#</a></h2><p>The Selinger query optimization algorithm uses dynamic programming over $n$ passes (where $n$ is the number of relations).</p><p>In each of the passes, we use the fact that left-deep plans can differ in the order of relations, access method for leaf operators, and join methods for join operators to enumerate all of the plans.</p><p>More specifically:</p><ul><li>In the 1st pass, find the best single relation plan for each relation. (what’s the best way to scan a table?)<ul><li>This includes full scans (# IOs = # pages in table) and index scans (# IOs depends on type of index and any applicable selects, since selections are pushed down)</li></ul></li><li>In each $i$ith pass, find the best way to join the result of an $i-1$ relation plan to the $i$th relation. (The $i-1$ plan will always be the outer relation due to the left-deep property.)</li><li>For each subset of relations, retain only:<ul><li>Cheapest plan overall for each combination of tables,</li><li>Cheapest plan for each interesting order of tuples</li></ul></li></ul><p><strong>The principle of optimality:</strong> the best overall plan is composed of the best decisions on the subplans. This means that if we find the cheapest way to join a subset of tables, we can add on more tables one by one by finding the cheapest cost for that single join operation.</p><h3 id=choosing-join-algorithms>Choosing Join Algorithms
<a class=anchor href=#choosing-join-algorithms>#</a></h3><p><strong>Table access with selections and projections:</strong></p><ul><li>Heap scan</li><li>Index scan if available</li></ul><p><strong>Equijoins:</strong></p><ul><li>Block nested loop join when simple algorithm needed</li><li>Index nested loop join if one relation is small and the other one is indexed</li><li>Sort-merge join if equal-size tables, small memory</li><li>Grace hash join if 1 table is small</li></ul><p><strong>Non equijoins:</strong></p><ul><li>Block nested loop join</li></ul><h3 id=interesting-orders>Interesting Orders
<a class=anchor href=#interesting-orders>#</a></h3><p>If a GROUP BY or ORDER BY clause will be processed later on, or a future join might benefit from the structure of the current join, it may be useful to take a temporary hit in IO cost in order to avoid needing to resort or regroup the table in a future step.</p><p>Only Sort Merge Join, Grace Hash Join, and index scans can produce interesting orders.</p><h3 id=full-sellinger-walkthrough>Full Sellinger Walkthrough
<a class=anchor href=#full-sellinger-walkthrough>#</a></h3><p>This problem is taken from
<a href="https://drive.google.com/file/d/1tTZSpPvhWM6z4VgqNn5AGksCjRjU7Mq9/view?usp=sharing" rel=noopener>Fall 2020 Midterm 2</a>.</p><p>Suppose we have the following query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> R.a, S.b, T.<span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> R <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> S <span style=color:#66d9ef>ON</span> R.a <span style=color:#f92672>=</span> S.a
</span></span><span style=display:flex><span><span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> T <span style=color:#66d9ef>ON</span> R.b <span style=color:#f92672>=</span> T.b
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> R.b <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>AND</span> T.<span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> S.b;
</span></span></code></pre></div><h4 id=pass-1>Pass 1
<a class=anchor href=#pass-1>#</a></h4><p>We&rsquo;re given the following possible single table access plans for Pass 1:
<img src=https://notes.bencuan.me/cs186/Sorting%20and%20Hashing/Pasted%20image%2020230109182021.png width=auto alt=sp1></p><p>(In reality, we&rsquo;d need to do selectivity estimation to find those numbers, but since you already did some <a href=#selectivity-estimation-practice rel=noopener class=internal-link data-src>practice</a>) we&rsquo;ll skip it for now.)</p><p>The first step is to identify the minimum cost accesses for each of the tables:</p><ul><li>Option (b) is the best way to access $R$, so we&rsquo;ll keep it.</li><li>Option (d) is the best way to access $S$, so we&rsquo;ll keep it.</li><li>Option (f) is the best way to access $T$, so we&rsquo;ll keep it.</li></ul><p>Next, we can identify any interesting orders:</p><ul><li>The only interesting order is (e), since we <code>GROUP BY s.b</code>, and (e) is an index scan on the same column.</li></ul><p>In summary, four plans would advance: b, d, e, f.</p><h4 id=pass-i>Pass i
<a class=anchor href=#pass-i>#</a></h4><p>Now for the 2nd pass, we will consider some ways to join two tables together:
<img src=https://notes.bencuan.me/cs186/Sorting%20and%20Hashing/Pasted%20image%2020230109182429.png width=auto alt=sp1></p><p>Let&rsquo;s start again by identifying the best way to join each combination of tables together:</p><ul><li>(b) is the best way to join $R$ with $S$.</li><li>(d) is the best way to join $S$ with $T$.</li><li>(e) is the best way to join $R$ with $T$.</li></ul><p>However, we can see that the original query does not actually join S with T! So we can safely discard (d), since we&rsquo;ll never end up using it.</p><p>Since there are no interesting orders here besides (b), the final result is that only (b) and (e) advance to Pass 3.</p><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/cs186// data-ctx="Query optimization" data-src=/cs186/ class=internal-link>Welcome to CS186!</a></li><li><a href=/cs186/io/ data-ctx="query optimization" data-src=/cs186/io class=internal-link>What is an I/O and why should I care?</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://notes.bencuan.me/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 Ben Cuan</p><ul><li><a href=https://notes.bencuan.me/>Home</a></li><li><a href=https://github.com/64bitpandas/notes/issues>Feedback</a></li><li><a href=https://bencuan.me>Website</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#introduction>Introduction</a></li><li><a href=#relevant-materials>Relevant Materials</a></li><li><a href=#system-r-optimizers>System R Optimizers</a></li><li><a href=#the-components-of-a-query-optimizer>The Components of a Query Optimizer</a></li><li><a href=#selectivity-estimation>Selectivity Estimation</a><ul><li><a href=#selectivity-estimation-practice>Selectivity Estimation Practice</a></li></ul></li><li><a href=#common-heuristics>Common Heuristics</a></li><li><a href=#selinger-query-optimization>Selinger Query Optimization</a><ul><li><a href=#choosing-join-algorithms>Choosing Join Algorithms</a></li><li><a href=#interesting-orders>Interesting Orders</a></li><li><a href=#full-sellinger-walkthrough>Full Sellinger Walkthrough</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>